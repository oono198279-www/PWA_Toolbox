<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PWA 🧰 Toolbox</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a84ff">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#1f2937; --sub:#6b7280;
    --theme:#0a84ff; --radius:14px; --shadow:0 6px 20px rgba(0,0,0,.08)
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;}

  /* ▼ 起動画面 ▼ */
  #splash{
    position:fixed;inset:0;display:grid;place-items:center;
    background:linear-gradient(180deg,#f3f8ff 0%,#e8f0ff 100%);
    transition:opacity .5s ease;z-index:999;
  }
  #splash.hide{opacity:0;pointer-events:none;visibility:hidden;}
  #splash .box{display:flex;flex-direction:column;align-items:center}
  #splash img{
    width:min(26vh,160px); height:min(26vh,160px);
    display:block; object-fit:contain;
    /* 画像に余白が入っていても中央に見えるように影付きで視認性UP（任意） */
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.15));
    margin-bottom:12px;
  }
  #splash p{font-size:20px;font-weight:bold;color:#334155;margin:0;}
  
  /* ▼ 本体 ▼ */
  header{position:sticky;top:0;background:linear-gradient(#fff,rgba(255,255,255,.7));
    backdrop-filter:saturate(180%) blur(8px);padding:16px 20px;border-bottom:1px solid #eee;z-index:10}
  h1{margin:0;font-size:20px;letter-spacing:.02em}
  main{padding:18px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .head{display:flex;align-items:center;gap:14px;padding:14px 16px;cursor:pointer;width:100%;
    background:none;border:0;text-align:left}
  .icon{width:56px;height:56px;border-radius:12px;background:#f0f3f8;display:grid;place-items:center;
    font-size:30px;overflow:hidden;flex:0 0 auto}
  .icon img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:700}
  .tagline{color:var(--sub);font-size:13px;margin-top:2px}
  .body{padding:0 16px 16px;border-top:1px solid #f1f1f1;display:none}
  .desc{color:#374151;line-height:1.6;white-space:pre-wrap;margin-top:10px}
  .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;text-decoration:none;display:inline-block}
  .btn.primary{background:var(--theme);color:#fff}
  .btn.ghost{background:#eef3ff;color:#0a4b9f}
  .open .body{display:block}
</style>
</head>
<body>
  <!-- 起動画面 -->
  <div id="splash">
    <div class="box">
      <img src="icons/icon-192.png" alt="logo">
      <p>PWA 🧰 Toolbox<br>Progressive Web Apps</p>
    </div>
  </div>

  <!-- 本体 -->
  <header><h1>PWA 🧰 Toolbox<br>Progressive Web Apps</h1></header>
  <main><section class="grid" id="grid"></section></main>

  <script type="application/json" id="apps-fallback">[]</script>

<script>
(async function () {
  const grid = document.getElementById('grid');
  const splash = document.getElementById('splash');

  // ← これを強化版に
  const hideSplash = () => {
    if (!splash) return;
    splash.classList.add('hide');        // フェード
    // フェード待っても待たなくても、最終的に消す（確実化）
    setTimeout(() => { splash.style.display = 'none'; }, 600);
    // 念のため即時でも消す（タイマーが凍っても見えないように）
    requestAnimationFrame(() => { splash.style.display = 'none'; });
  };

  // 3系統＋フェールセーフ
  setTimeout(hideSplash, 2200);
  document.addEventListener('DOMContentLoaded', hideSplash, { once: true });
  window.addEventListener('load', hideSplash, { once: true });

  // apps.json を取得 → カード描画
  let apps = [];
  try {
    const res = await fetch('apps.json', { cache: 'no-cache' });
    if (!res.ok) throw new Error(res.statusText);
    apps = await res.json();
  } catch {
    try {
      apps = JSON.parse(document.getElementById('apps-fallback').textContent || '[]');
    } catch {}
  }

  if (!Array.isArray(apps) || apps.length === 0) {
    grid.innerHTML = '<p>アプリ一覧が空です。apps.json を編集してください。</p>';
  } else {
    apps.forEach(app => grid.appendChild(renderCard(app)));
  }

  // Service Worker
  if ('serviceWorker' in navigator) {
    try { await navigator.serviceWorker.register('./sw.js'); } catch {}
  }

  // ------- 以下はUIユーティリティ -------
  function renderCard(app) {
    const card = document.createElement('article');
    card.className = 'card';

    const head = document.createElement('button');
    head.className = 'head';
    head.innerHTML = `
      <div class="icon">${iconHTML(app.icon)}</div>
      <div>
        <div class="title">${esc(app.name)}</div>
        <div class="tagline">${esc(app.tagline || '')}</div>
      </div>`;

    const body = document.createElement('div');
    body.className = 'body';
    body.innerHTML = `
      <div class="desc">${esc(app.description || '')}</div>
      <div class="actions">
        <a class="btn primary" href="${app.url}" target="_blank" rel="noopener">開く</a>
        <button class="btn ghost" type="button">リンク</button>
      </div>`;

    head.onclick = () => card.classList.toggle('open');
    body.querySelector('.btn.ghost').onclick = async () => {
      try { await navigator.clipboard.writeText(app.url); alert('URLをコピーしました'); }
      catch { prompt('コピーできない環境です。手動でコピーしてください：', app.url); }
    };

    card.append(head, body);
    return card;
  }

  function iconHTML(src) {
    return (/^https?:|^\.{0,2}\//.test(src))
      ? `<img alt="" src="${esc(src)}">`
      : esc(src || '🧩');
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'
    }[m]));
  }
})();
</script>


</body>
</html>